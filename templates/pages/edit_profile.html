{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Мой профиль {% endblock title %}

{% block content %}
<style>
    #textfield{
        resize: none;
    }
	
</style>


<form method="POST" id="profileForm"enctype="multipart/form-data">
    {% csrf_token %}
<div class="container-sm my-5 bg-white col-6 border border-dark rounded-3 border-2" id="account">
    <div class="row p-3"">
        <div class="col-4 text-center"><img class=" border border-dark border-2 rounded-circle"src="{{account.prof_image.url}}"  width="100%" alt="prof_image"</img>
            <label id="change_image" class="btn btn-success btn-sm my-2 justify-content-center">Сменить фото {{form.prof_image}}</label>
        </div>
        <div class="col-8">
        <div class="row">
        
            <div class="row">
                <div class="col-6">{{form.first_name.label}}{{form.first_name}}</div> 
                <div class="col-6">{{form.second_name.label}}{{form.second_name}}</div>
            <div class="row">
                <div id="textfield" class="col-12 p-4">{{form.about|as_crispy_field}}</div>
            </div>
        </div>
        </div>
    </div>
</div>
<button id ="classicSubmit" type="submit" class='btn btn-success my-5 position-relative top-50 start-50 translate-middle'>
    Редактировать
</button>

<div class="form-group"> 
    <button class="btn btn-outline-info" id="confirm-btn" style="width: 100%; margin-top: 10px; display: none" type="submit">Опубликовать</button>
  </div>
</form>
	 <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="cropModalLabel">Modal title</h5>
			  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div id="image-box" class="image-container"></div>
			</div>
			<div class="modal-footer">
			  <button id="cancel-crop" type="button" class="btn btn-danger" data-bs-dismiss="modal">Отмена</button>
			  <button id="crop-btn" class="btn btn-success" data-bs-dismiss="modal" type="button">Обрезать</button>
			</div>
		  </div>
		</div>
	  </div>
 


	  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
 //image-box is the id of the div element that will store our cropping image preview
	const imagebox = document.getElementById('image-box')
        // crop-btn is the id of button that will trigger the event of change original file with cropped file.
	const crop_btn = document.getElementById('crop-btn')
	const cancel_btn = document.getElementById('cancel-crop')
	// id_image is the id of the input tag where we will upload the image
	const input = document.getElementById('id_prof_image')
	cancel_btn.addEventListener('click', () =>{
		  document.getElementById("id_prof_image").value = ""
	  })
	// When user uploads the image this event will get triggered
	input.addEventListener('change', ()=>{
	  // Getting image file object from the input variable
	  const img_data = input.files[0]
	  // createObjectURL() static method creates a DOMString containing a URL representing the object given in the parameter.
	  // The new object URL represents the specified File object or Blob object.
	  const url = URL.createObjectURL(img_data)
	  // Creating a image tag inside imagebox which will hold the cropping view image(uploaded file) to it using the url created before.
	  imagebox.innerHTML = `<img src="${url}" id="image" style="width:100%;">`
	  // Storing that cropping view image in a variable
	  
	  const image = document.getElementById('image')
	  $("#cropModal").modal("show");
	  // Displaying the image box
	  document.getElementById('image-box').style.display = 'block'
	  // Displaying the Crop buttton
	  document.getElementById('crop-btn').style.display = 'block'
	  // Hiding the Post button
	  document.getElementById('confirm-btn').style.display = 'none'
	 
	  
	  // Creating a croper object with the cropping view image
	  // The new Cropper() method will do all the magic and diplay the cropping view and adding cropping functionality on the website
	  // For more settings, check out their official documentation at https://github.com/fengyuanchen/cropperjs
	  $("#cropModal").on("shown.bs.modal", function () {
	  const cropper = new Cropper(image, {
      aspectRatio: 9 / 9,
	  autoCropArea: 1,
	  viewMode: 1,
	  scalable: false,
	  zoomable: false,
	  movable: false,
	  minCropBoxWidth: 200,
	  minCropBoxHeight: 200,
	  })
	
	 
	  // When crop button is clicked this event will get triggered
	  crop_btn.addEventListener('click', ()=>{
	    // This method coverts the selected cropped image on the cropper canvas into a blob object
	    cropper.getCroppedCanvas().toBlob((blob)=>{
	      // Gets the original image data
	      let fileInputElement = document.getElementById('id_prof_image');
	      // Make a new cropped image file using that blob object, image_data.name will make the new file name same as original image
	      let file = new File([blob], img_data.name,{type:"image/*", lastModified:new Date().getTime()});
	      // Create a new container
	      let container = new DataTransfer();
	      // Add the cropped image file to the container
	      container.items.add(file);
	      // Replace the original image file with the new cropped image file
	      fileInputElement.files = container.files;
		 
	      // Hide the cropper box
	      //document.getElementById('image-box').style.display = 'none'
	      // Hide the crop button
	      document.getElementById('crop-btn').style.display = 'none'
	      // Display the Post button
	      //document.getElementById('confirm-btn').style.display = 'block'
		  document.getElementById('confirm-btn').click()
			
	      });
	    });
	});	
})
</script>
{% endblock content %}